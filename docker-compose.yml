version: '3.8'

services:
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile.celery
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # Variables adicionales para debugging
      - PYTHONUNBUFFERED=1
      - CELERY_LOG_LEVEL=INFO
    depends_on:
      - redis
    volumes:
      - .:/app
    
    # CLAVE: Acceso al host Windows
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # Comando con verificación de conectividad
    command: [
      "sh", "-c", 
      "echo 'Verificando conectividad...' && 
       ping -c 2 host.docker.internal || echo 'Ping falló pero continuando...' && 
       echo 'Iniciando Celery Worker...' && 
       celery -A app.core.celery.celery_app worker --loglevel=info"
    ]

volumes:
  redis-data: